#!/usr/bin/env bash
# ğŸ‰ Subak Player ğŸ‰

DIR="/home/dan/Media/SOUND/Twinkling Watermelon (1969)"
MESG="ğŸ¶  â–º  Now Playing: âœ¨ ë°˜ì§ì´ëŠ” ì›Œí„°ë©œë¡  ğŸ‰ "
TMPF="/tmp/playmesg.txt"

# Index of song to loop from
start_index=10 # 11th File

ascii_box "$MESG" > "$TMPF"

draw_header() {
    clear
    ascii_center "/home/dan/Documents/asclepius"
    ascii_center "/home/dan/Documents/todo"
    echo
    ascii_center "$TMPF"
}

MPV_OPTS=(
    --force-window=no
    --no-video --term-osd-bar
    --display-tags=no
    --msg-level=ffmpeg/demuxer=no,ao=no,af=no
    --term-status-msg=$'â³  ${time-pos} / ${duration}  âœ§  ${percent-pos}%'
    --term-playing-msg=$'\nğŸ‰ ${metadata/title} Â· ${metadata/artist} Â· ${metadata/album} ğŸ‰'
)

# âš”ï¸  Once Playthrough

for TRACK in "$DIR"/*.{mp3,flac,wav,ogg,m4a,opus,aac,wma} ; do
    [[ -f "$TRACK" ]] || continue

    draw_header

    mpv \
        "${MPV_OPTS[@]}" \
        --loop-playlist=no \
        "$TRACK"
done

shopt -s nullglob

# ğŸ§ Ambient BGM Mode

while true; do
    mapfile -t files < <(printf '%s\n' "$DIR"/*.{mp3,flac,wav,ogg,opus,m4a,aac} 2>/dev/null | sort -fV)

    # Play from start_index to end
    for (( i = start_index; i < ${#files[@]}; i++ )); do
        file="${files[i]}"
        [[ -f "$file" ]] || continue

        draw_header
        mpv \
            "${MPV_OPTS[@]}" \
            --loop-playlist=no \
            "$file"
    done
    sleep 0.5
done
